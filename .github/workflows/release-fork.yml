name: Release (Fork)

on:
  push:
    tags: ["v*"]
  workflow_dispatch:
    inputs:
      tag:
        description: "Tag to release (e.g. v11.14.5)"
        required: true
        type: string

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: true

jobs:
  native:
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            platform: linux
            arch: x64
          - os: ubuntu-latest
            platform: linux
            arch: arm64
            target: aarch64-unknown-linux-gnu
          - os: macos-13
            platform: darwin
            arch: x64
          - os: macos-14
            platform: darwin
            arch: arm64
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4
        with:
          lfs: true
      - uses: dtolnay/rust-toolchain@nightly
        with:
          targets: ${{ matrix.target }}
      - uses: Swatinem/rust-cache@v2
        with:
          key: ${{ matrix.target }}
      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: "1.3"
      - name: Install cross-compilation toolchain
        if: matrix.target == 'aarch64-unknown-linux-gnu'
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc-aarch64-linux-gnu
      - name: Build native addon
        env:
          CROSS_TARGET: ${{ matrix.target }}
          TARGET_PLATFORM: ${{ matrix.platform }}
          TARGET_ARCH: ${{ matrix.arch }}
          CARGO_TARGET_AARCH64_UNKNOWN_LINUX_GNU_LINKER: aarch64-linux-gnu-gcc
        run: bun --cwd=packages/natives run build:native
      - name: Upload native addon
        uses: actions/upload-artifact@v4
        with:
          name: pi-natives-${{ matrix.platform }}-${{ matrix.arch }}
          path: packages/natives/native/pi_natives.${{ matrix.platform }}-${{ matrix.arch }}.node
          if-no-files-found: error

  build-and-release:
    needs: [native]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          lfs: true
      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: "1.3"
      - name: Cache bun dependencies
        uses: actions/cache@v4
        with:
          path: ~/.bun/install/cache
          key: bun-${{ runner.os }}-${{ hashFiles('**/bun.lock') }}
      - run: bun install --frozen-lockfile
      - name: Download native addons
        uses: actions/download-artifact@v4
        with:
          pattern: pi-natives-*
          path: packages/natives/native
          merge-multiple: true
      - name: Verify native addons
        run: |
          for plat in linux-x64 linux-arm64 darwin-x64 darwin-arm64; do
            if [ -f "packages/natives/native/pi_natives.${plat}.node" ]; then
              echo "OK pi_natives.${plat}.node"
            else
              echo "MISSING pi_natives.${plat}.node"
              exit 1
            fi
          done
      - name: Build binaries
        run: |
          mkdir -p packages/coding-agent/binaries
          ENTRYPOINT="./packages/coding-agent/src/cli.ts"
          DEFINES="--define PI_COMPILED=true --root ."
          build_binary() {
            PLATFORM="$1"
            ARCH="$2"
            TARGET="$3"
            OUTFILE="$4"
            TARGET_PLATFORM="$PLATFORM" TARGET_ARCH="$ARCH" bun --cwd=packages/natives run embed:native
            bun build --compile $DEFINES --target="$TARGET" "$ENTRYPOINT" --outfile "$OUTFILE"
          }
          build_binary darwin arm64 bun-darwin-arm64 packages/coding-agent/binaries/oomp-darwin-arm64
          build_binary darwin x64 bun-darwin-x64 packages/coding-agent/binaries/oomp-darwin-x64
          build_binary linux x64 bun-linux-x64 packages/coding-agent/binaries/oomp-linux-x64
          build_binary linux arm64 bun-linux-arm64 packages/coding-agent/binaries/oomp-linux-arm64
          bun --cwd=packages/natives run embed:native --reset
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: packages/coding-agent/binaries/*
          generate_release_notes: true
          tag_name: ${{ inputs.tag || github.ref_name }}
